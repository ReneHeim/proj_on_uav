# .github/workflows/version.yml
name: versioning
on:
  push: { branches: [dev] }
  pull_request: { types: [closed], branches: [main] }
  workflow_dispatch: { inputs: { major: { type: boolean, default: false } } }
permissions: { contents: write }
jobs:
  bump_and_release:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true || github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-python@v5
      - run: pip install bump2version build

      - name: Configure git user
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --local user.name "Mak8427"
          git config --local user.email "davide.mattioli.2001@gmail.com"

      - id: part
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.major }}" = "true" ]; then echo part=major >> $GITHUB_OUTPUT; elif [ "${{ github.event_name }}" = "pull_request" ]; then echo part=minor >> $GITHUB_OUTPUT; else echo part=patch >> $GITHUB_OUTPUT; fi
      

      # bump and push commit + tag back to the repo
      - name: Bump version
        run: |
          bump2version ${{ steps.part.outputs.part }}
          git push --follow-tags

      - name: Sync version bump back to dev
        if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
        run: |
          git fetch origin dev
          git checkout dev
          git merge --ff-only main || git merge --no-ff -m "Sync version bump from main"
          git push origin dev
    

      # build artifacts only for MINOR/MAJOR (non-push events)
      - if: github.event_name != 'push'
        run: python -m build

      # create GitHub Release with the built artifacts
      - if: github.event_name != 'push'
        run: gh release create "$(git describe --tags --abbrev=0)" dist/* --latest --notes "Automated ${{ steps.part.outputs.part }} release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
