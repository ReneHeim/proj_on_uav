name: CI Status

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  ci-status:
    name: CI Status Summary
    runs-on: ubuntu-latest
    needs: []  # This will be empty, we'll use GitHub's API instead
    if: always()

    steps:
      - name: Check all workflows status
        uses: actions/github-script@v7
        with:
          script: |
            // Get all workflow runs for this commit
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: context.sha,
              status: 'completed'
            });
            
            const requiredWorkflows = ['Tests & Quality', 'Security Scan', 'Build Package'];
            const workflowResults = {};
            
            for (const run of runs.workflow_runs) {
              if (requiredWorkflows.includes(run.name)) {
                workflowResults[run.name] = run.conclusion;
              }
            }
            
            console.log('Workflow Results:', workflowResults);
            
            const failed = Object.values(workflowResults).some(result => 
              result === 'failure' || result === 'cancelled'
            );
            
            if (failed) {
              core.setFailed('One or more required workflows failed');
            } else {
              console.log('âœ… All required workflows passed!');
            }